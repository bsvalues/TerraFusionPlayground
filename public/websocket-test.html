<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TerraFusion WebSocket Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      color: #333;
    }
    h1 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    pre {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      overflow: auto;
      border: 1px solid #e9ecef;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      font-size: 14px;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
    input {
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      font-size: 14px;
      width: 300px;
    }
    .connection-status {
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .connecting {
      background-color: #fff3cd;
      color: #856404;
    }
    .log-container {
      height: 300px;
      overflow-y: auto;
    }
    .info {
      margin-top: 30px;
      padding: 15px;
      background-color: #e7f5fe;
      border-left: 5px solid #3498db;
      border-radius: 3px;
    }
    .error {
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>TerraFusion WebSocket Test</h1>
  
  <div id="status" class="connection-status disconnected">Disconnected</div>
  
  <div>
    <button id="connect">Connect</button>
    <button id="disconnect" disabled>Disconnect</button>
  </div>
  
  <h2>Send Message</h2>
  <div>
    <input type="text" id="message" placeholder="Enter message..." value="Hello from WebSocket client">
    <button id="send" disabled>Send</button>
  </div>
  
  <h2>Communication Log</h2>
  <div class="log-container">
    <pre id="log"></pre>
  </div>
  
  <div class="info">
    <h3>WebSocket Connection Information</h3>
    <p>This page tests the TerraFusion WebSocket server running on the <code>/ws</code> path.</p>
    <p>The WebSocket server is configured to:</p>
    <ul>
      <li>Echo messages back with timestamp</li>
      <li>Send a welcome message on connection</li>
      <li>Support real-time monitoring updates</li>
    </ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const connectBtn = document.getElementById('connect');
      const disconnectBtn = document.getElementById('disconnect');
      const sendBtn = document.getElementById('send');
      const messageInput = document.getElementById('message');
      const logElement = document.getElementById('log');
      const statusElement = document.getElementById('status');
      
      let socket = null;
      
      function updateStatus(status, message) {
        statusElement.className = `connection-status ${status}`;
        statusElement.textContent = message;
      }
      
      function log(message, error = false) {
        const entry = document.createElement('div');
        entry.textContent = `[${new Date().toISOString()}] ${message}`;
        if (error) entry.className = 'error';
        logElement.appendChild(entry);
        logElement.scrollTop = logElement.scrollHeight;
      }
      
      connectBtn.addEventListener('click', () => {
        if (socket) {
          log('Already connected, disconnecting first...');
          socket.close();
        }
        
        updateStatus('connecting', 'Connecting...');
        log('Attempting to connect to WebSocket server...');
        
        try {
          // Create WebSocket connection with the correct protocol (ws/wss)
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/ws`;
          log(`Connecting to: ${wsUrl}`);
          
          socket = new WebSocket(wsUrl);
          
          socket.onopen = (event) => {
            log('Connection established successfully!');
            updateStatus('connected', 'Connected');
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            sendBtn.disabled = false;
          };
          
          socket.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              log(`Received: ${JSON.stringify(data, null, 2)}`);
            } catch (e) {
              log(`Received non-JSON message: ${event.data}`);
            }
          };
          
          socket.onclose = (event) => {
            const reason = event.reason ? ` Reason: ${event.reason}` : '';
            log(`Connection closed. Code: ${event.code}.${reason}`);
            updateStatus('disconnected', 'Disconnected');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            sendBtn.disabled = true;
            socket = null;
          };
          
          socket.onerror = (error) => {
            log(`WebSocket error: ${error.message || 'Unknown error'}`, true);
            updateStatus('disconnected', 'Error - See log');
          };
        } catch (error) {
          log(`Failed to create WebSocket connection: ${error.message}`, true);
          updateStatus('disconnected', 'Connection Failed');
        }
      });
      
      disconnectBtn.addEventListener('click', () => {
        if (socket) {
          log('Closing connection...');
          socket.close();
        }
      });
      
      sendBtn.addEventListener('click', () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
          const message = messageInput.value.trim();
          if (message) {
            try {
              // Try to send as JSON
              const jsonMessage = { text: message, timestamp: new Date().toISOString() };
              log(`Sending: ${JSON.stringify(jsonMessage)}`);
              socket.send(JSON.stringify(jsonMessage));
            } catch (error) {
              log(`Error sending message: ${error.message}`, true);
            }
          } else {
            log('Cannot send empty message');
          }
        } else {
          log('Cannot send message, not connected', true);
        }
      });
      
      // Allow pressing Enter to send a message
      messageInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && !sendBtn.disabled) {
          sendBtn.click();
        }
      });
      
      // Display WebSocket information on page load
      log('WebSocket test page loaded');
      
      // Auto-connect if the URL has ?autoconnect=true
      if (new URLSearchParams(window.location.search).get('autoconnect') === 'true') {
        log('Auto-connect enabled, connecting...');
        connectBtn.click();
      }
    });
  </script>
</body>
</html>